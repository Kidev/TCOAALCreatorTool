<!--
    TCOAAL Creator Tool
    Copyright (C) 2025, Alexandre 'kidev' Poumaroux

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <link href="favicon.ico" rel="icon" type="image/x-icon" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <meta name="author" content="Alexandre 'kidev' Poumaroux" />
        <title>kidev's TCOAAL Creator Tool</title>
        <link href="colors.css" rel="stylesheet" />
        <link href="viewer.css" rel="stylesheet" />
        <link href="editor.css" rel="stylesheet" />
        <script src="js/libs/lz-string.min.js"></script>
        <script src="js/libs/gif.js"></script>
        <script src="js/libs/html2canvas.min.js" defer></script>
    </head>
    <body>
        <div id="forcedImportOverlay" class="forced-import-overlay" style="display: none">
            <a
                href="https://github.com/Kidev/TCOAALCreatorTool"
                target="_blank"
                rel="noopener"
                class="mobile-github-link"
                style="position: absolute; top: 0; right: 0"
                onclick="event.stopPropagation()"
            >
                <svg class="github-icon" viewBox="0 0 24 24">
                    <path
                        d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"
                    />
                </svg>
                <span style="font-size: 1vmax">View on GitHub</span>
            </a>
            <div
                class="forced-import-content"
                style="height: 100vh; justify-content: center; margin-top: 0; position: relative"
            >
                <!--<img alt="Dialog Creator" class="forced-import-logo" src="img/tcoaal-title.webp" />-->

                <button style="font-size: 2vmax" class="composition-btn" onclick="handleForcedImport()">
                    Import Game Assets
                </button>
                <!--<p class="forced-import-message">
                    This tool requires game assets to function.<br />
                    Please import your game folder to continue.
                </p>-->
                <p
                    class="forced-import-note"
                    style="
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                        margin: 0;
                        padding: 2vmax;
                        line-height: 1;
                        position: absolute;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                    "
                >
                    This tool requires the game assets<br />You need to own The Coffin of Andy and Leyley
                    <iframe
                        id="steam-buy-frame"
                        src="https://store.steampowered.com/widget/2378900/"
                        frameborder="0"
                        width="646"
                        height="190"
                    ></iframe>
                </p>
            </div>
        </div>
        <div id="importProgressModal" class="import-modal" style="display: none">
            <div class="import-modal-content">
                <div class="import-progress-bar">
                    <div id="importProgressFill" class="import-progress-fill"></div>
                </div>
                <div id="importProgressText" class="import-progress-text">Processing...</div>
            </div>
        </div>
        <div id="galleryModal" class="gallery-modal" style="display: none">
            <div id="galleryModalContent" class="gallery-modal-content">
                <!--<div
                    class="gallery-header"
                    style="
                        display: flex;
                        flex-direction: row;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1vmin;
                        gap: 1vmin;
                    "
                >
                    <div class="h2">Assets Gallery</div>
                    <div id="croppingProgressIndicatorModal" style="display: none">
                        <div class="bar" id="croppingProgressBarModal"></div>
                        <span class="label" id="croppingProgressSpanModal">Cropping...</span>
                    </div>
                    <-<button class="tcoaal-button-small composition-editor-open-btn" onclick="openCompositionEditor()" title="Open composition editor to create custom scenes">
                        üñº Composition Editor
                    </button>->
                    <button class="gallery-close-btn" onclick="closeGallery()">‚úï</button>
                </div>-->
                <div id="galleryMainContainer" class="gallery-main-container">
                    <div class="gallery-left-panel">
                        <div class="gallery-tabs">
                            <button class="gallery-tab active" onclick="switchGalleryTab('images')">Images</button>
                            <button class="gallery-tab" onclick="switchGalleryTab('audio')">Audio</button>
                        </div>
                        <div class="gallery-categories" id="galleryCategories"></div>
                        <div class="gallery-content" id="galleryContent"></div>
                    </div>
                    <div class="gallery-preview-panel" id="galleryPreviewPanel">
                        <div class="preview-panel-header">
                            <h3 class="preview-title-bar">Preview<span id="previewCropBoxContainer"></span></h3>
                            <button class="preview-download-btn" id="previewDownloadBtn" style="display: none">
                                ‚èé Use
                            </button>
                        </div>
                        <div class="preview-panel-content" id="previewPanelContent">
                            <div class="preview-placeholder">Select an item to preview</div>
                        </div>
                        <div class="preview-controls" id="previewControls"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Composition Editor Modal -->
        <div id="compositionEditorModal" class="composition-editor-modal" style="display: none">
            <div class="composition-editor-content">
                <div class="composition-editor-header">
                    <h2>Compositor</h2>
                    <div class="composition-notification-area" id="compositionNotificationArea"></div>
                    <div class="composition-header-actions">
                        <input
                            type="text"
                            id="compositionNameInput"
                            placeholder="composition_1"
                            maxlength="50"
                            title="Name for this composition"
                            style="
                                padding: 8px;
                                border-radius: 4px;
                                border: 1px solid #666;
                                background: #222;
                                color: #ddd;
                                font-family: monospace;
                                max-width: 200px;
                            "
                        />
                        <button
                            class="composition-btn success"
                            onclick="compositionEditor.saveToGallery()"
                            title="Save composition to gallery for reuse and sharing"
                        >
                            ‚úî Save to gallery
                        </button>
                        <!--<button class="composition-btn danger" onclick="compositionEditor.clearAllLayers()" title="Remove all layers">
                            Clear All
                        </button>-->
                        <button class="composition-btn danger" onclick="compositionEditor.close()" title="Close editor">
                            Close
                        </button>
                    </div>
                </div>
                <div class="composition-editor-main">
                    <div class="composition-canvas-panel">
                        <div class="composition-preview-bg-controls">
                            <label
                                for="previewBackgroundFile"
                                style="display: none; font-size: 0.9vmax; color: var(--txt-color)"
                            ></label>
                            <input
                                type="file"
                                id="previewBackgroundFile"
                                accept="image/*"
                                style="display: none"
                                onchange="compositionEditor.loadPreviewBackground(this.files[0])"
                            />
                            <button
                                id="previewBackgroundSelectBtn"
                                onclick="document.getElementById('previewBackgroundFile').click()"
                                style="font-size: 0.8vmax; padding: 4px 8px"
                                title="Select background image for preview only"
                            >
                                Template
                            </button>
                            <button
                                id="previewBackgroundToggleBtn"
                                onclick="compositionEditor.togglePreviewBackground()"
                                style="font-size: 0.8vmax; padding: 4px 8px; display: none"
                                title="Hide/Show background"
                                class="success"
                            >
                                ‚òë
                            </button>
                            <button
                                id="previewBackgroundRemoveBtn"
                                onclick="compositionEditor.removePreviewBackground()"
                                style="font-size: 0.8vmax; padding: 4px 8px; display: none"
                                title="Remove background"
                                class="danger"
                            >
                                ‚úï
                            </button>
                        </div>
                        <div class="composition-canvas-container">
                            <canvas id="compositionCanvas"></canvas>
                        </div>
                    </div>
                    <div class="composition-layers-panel">
                        <div class="composition-layers-header">
                            <div><h3>Layers</h3></div>
                            <div>
                                <button
                                    id="exportGifBtn"
                                    class="preview-control-btn"
                                    onclick="compositionEditor.exportAsGif()"
                                    title="Export composition as GIF"
                                    style="display: none"
                                >
                                    GIF
                                </button>
                                <button
                                    id="exportPngBtn"
                                    class="preview-control-btn"
                                    onclick="compositionEditor.exportComposition()"
                                    title="Export composition as PNG"
                                    style="display: none"
                                >
                                    PNG
                                </button>
                                <button
                                    id="exportOggBtn"
                                    class="preview-control-btn"
                                    onclick="compositionEditor.exportAsOgg(false)"
                                    title="Export audio timeline as WAV"
                                    style="display: none"
                                >
                                    WAV
                                </button>
                            </div>
                        </div>
                        <div class="composition-layers-list" id="compositionLayersList">
                            <div class="no-layers-message">No layers yet. Add assets from the gallery!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="file" id="folderInput" style="display: none" webkitdirectory directory multiple />
        <div class="controls" id="controlsContainer">
            <div class="controller-viewer-line0">
                <button
                    id="homeButton"
                    class="controller-buttons-viewer"
                    onclick="window.location.href = 'index.html'"
                    title="Return to home screen"
                >
                    <img src="favicon.ico" alt="Home" width="1vmax" height="1vmax" />
                </button>
                <button class="controller-buttons-viewer" onclick="openEditor()" title="Edit the dialog">üõ†</button>

                <button id="presetsButton" class="controller-buttons-viewer" title="Load a preset sequence">üóÇ</button>
                <button
                    id="playSequenceButton"
                    class="controller-buttons-viewer"
                    onclick="dialogFramework.playPauseSequence()"
                    title="Play / Pause entire sequence"
                >
                    ‚ñ∂
                </button>
                <button
                    id="resetButton"
                    class="controller-buttons-viewer"
                    onclick="dialogFramework.reset()"
                    title="Reset"
                >
                    ‚ü≤
                </button>
                <button
                    id="prevButton"
                    class="controller-buttons-viewer"
                    onclick="dialogFramework.previous()"
                    title="Previous (left arrow)"
                >
                    ‚¨Ö
                </button>
                <div class="controller-buttons-viewer controller-buttons-viewer-select disabled" id="debugInfo">
                    No scene
                </div>
                <button
                    id="nextButton"
                    class="controller-buttons-viewer"
                    onclick="dialogFramework.next()"
                    title="Next (right arrow, click or space)"
                >
                    ‚û°
                </button>

                <button
                    id="screenshotButton"
                    class="controller-buttons-viewer"
                    onclick="captureScreenshot()"
                    title="Screenshot"
                >
                    üñº
                </button>
                <button
                    id="recordButton"
                    class="controller-buttons-viewer"
                    onclick="toggleRecording()"
                    title="Record (right-click for settings)"
                >
                    üìΩ
                </button>
            </div>
            <div class="controls-footer">
                <span class="controls-title">Use tab to toggle the interface</span>
            </div>
        </div>
        <div class="game-container">
            <div class="dialog-container" id="dialogContainer">
                <div class="dialog-content">
                    <div class="dialog-line speaker-line" id="speakerLine"></div>
                    <div class="dialog-line text-line" id="textLine1"></div>
                    <div class="dialog-line text-line" id="textLine2"></div>
                    <div id="dialogArrow"></div>
                </div>
            </div>
            <div id="choicesContainer" class="choices-container"></div>
        </div>
        <div class="interaction-blocker" id="interactionBlocker"></div>
        <div class="editor-overlay spa-mode" id="editorOverlay" onclick="event.stopPropagation()">
            <div class="editor-header" id="editorHeader">
                <div class="editor-zone left" id="editorHeaderZoneLeft">
                    <div class="header-buttons">
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header game-import"
                            onclick="handleGameImportClick()"
                            title="Import all the assets from your game folder"
                            id="import-game-assets-button"
                        >
                            Game assets
                        </button>
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header js-upload"
                            onclick="importSequence()"
                            title="Import a dialog from file, will replace the current one
                                Right click to reveal link sharing button"
                        >
                            Import file
                        </button>
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header js-download"
                            onclick="downloadSequence()"
                            title="Export the current dialog as a .js file
                            Right click to reveal link sharing button"
                        >
                            Export file
                        </button>
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header js-download"
                            onclick="generateShareLink()"
                            title="Generate a shareable link with the current dialog encoded in the URL
                            Right click to reveal file buttons"
                        >
                            Share link
                        </button>

                        <!--<button
                                class="tcoaal-button-small tcoaal-button-small-header js-save"
                                onclick="saveSequence()"
                                title="Save the current dialog to browser storage"
                        >
                            Save
                        </button>
                        <button
                                class="tcoaal-button-small tcoaal-button-small-header js-clear danger"
                                onclick="clearSavedSequence()"
                                title="Clear saved dialog from browser storage"
                                style="display: none"
                                id="clearSavedBtn"
                        >
                            Clear Saved
                        </button>-->
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header js-save"
                            onclick="saveSequence()"
                            oncontextmenu="handleSaveRightClick(event)"
                            title="Save the current dialog to browser storage
Right click to erase the saved dialog"
                        >
                            Save
                        </button>

                        <!--<button
                            class="tcoaal-button-small tcoaal-button-small-header js-upload"
                            onclick="importFromLink()"
                            title="Import a dialog from a share link or code"
                        >
                            Import Link
                        </button>-->
                    </div>
                </div>
                <div class="editor-zone center">
                    <div class="editor-header-content">
                        <a href="." title="Back to home screen"
                            ><img alt="Dialog Creator" class="editor-title-image" src="img/tcoaal-title.webp"
                        /></a>
                    </div>
                </div>
                <div class="editor-zone right">
                    <div class="header-buttons">
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header overlay-close"
                            onclick="closeEditor(true)"
                            title="Cancel changes and return to the animation screen"
                        >
                            Cancel
                        </button>
                        <button
                            class="tcoaal-button-small tcoaal-button-small-header save-button"
                            onclick="runSequence()"
                            title="Apply the changes made and return to the animation screen"
                        >
                            Play
                        </button>
                    </div>
                </div>
            </div>
            <div class="editor-container" onclick="event.stopPropagation()">
                <div class="section">
                    <button class="section-header collapsible" onclick="toggleSection(this)">Configuration</button>
                    <div class="section-content">
                        <div class="subsection">
                            <h3>General configuration</h3>
                            <button class="reset-default reset-section" onclick="resetConfigToDefault()">
                                Reset to default
                            </button>
                            <div class="form-group no-checkbox">
                                <label for="configShowControls">Show controls:</label>
                                <input checked id="configShowControls" type="checkbox" />
                            </div>
                            <div class="form-group no-checkbox" style="display: none">
                                <label for="configShowDebug">Show scene count:</label>
                                <input checked id="configShowDebug" type="checkbox" />
                            </div>
                            <div class="form-group no-checkbox">
                                <label for="configShowDialogArrow">Show dialog arrow:</label>
                                <input checked id="configShowDialogArrow" type="checkbox" />
                            </div>

                            <div class="form-group" style="display: none">
                                <input
                                    class="null-checkbox"
                                    id="backgroundMusicEnabled"
                                    onchange="toggleBackgroundMusic(this.checked)"
                                    title="Enable/disable background music"
                                    type="checkbox"
                                />
                                <label for="backgroundMusicEnabled">Background music:</label>
                                <label for="select-bgmusic" style="display: none"></label>
                                <div class="file-select-wrapper" id="bgmusic-wrapper" style="display: none">
                                    <select
                                        class="file-type-select"
                                        id="select-bgmusic"
                                        onchange="handleBackgroundMusicTypeChange(this.value)"
                                    >
                                        <option value="local">Local</option>
                                        <option value="url">URL</option>
                                        <option value="gallery">Gallery</option>
                                    </select>
                                    <div
                                        id="select-bgmusic-container"
                                        style="flex: 1; display: flex; align-items: center; gap: 0.8vmax"
                                    >
                                        <input
                                            accept="audio/*"
                                            disabled
                                            id="backgroundMusicFile"
                                            onchange="handleBackgroundMusicUpload(this)"
                                            type="file"
                                        />
                                        <button
                                            class="file-select-button"
                                            disabled
                                            id="backgroundMusicButton"
                                            onclick="document.getElementById('backgroundMusicFile').click()"
                                        >
                                            <span class="filename" id="selectbgMusicFile">Select file</span>
                                        </button>
                                        <button
                                            class="play-button"
                                            id="bg-music-button"
                                            onclick="toggleBackgroundMusicPreview()"
                                            style="display: none"
                                        >
                                            ‚ñ∂ Play
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" id="backgroundMusicVolumeGroup" style="display: none">
                                <label for="backgroundMusicVolume" style="grid-column: 2">Music volume:</label>
                                <input
                                    id="backgroundMusicVolume"
                                    style="grid-column: 3"
                                    max="1"
                                    min="0"
                                    onchange="updateBackgroundMusicVolume(this.value)"
                                    step="0.1"
                                    type="number"
                                    value="0.5"
                                />
                            </div>
                        </div>
                        <div class="subsection">
                            <h4
                                class="collapsible-group-header"
                                style="font-size: 0.95vw"
                                onclick="toggleSceneGroup(this)"
                            >
                                Glitch effect
                            </h4>
                            <div class="collapsible-group-content" style="display: none">
                                <button class="reset-default reset-section" onclick="resetGlitchToDefault()">
                                    Reset to default
                                </button>
                                <div class="form-group no-checkbox">
                                    <label for="glitchScrambledColor">Scrambled color:</label>
                                    <input id="glitchScrambledColor" type="color" />
                                </div>
                                <div class="form-group no-checkbox">
                                    <label for="glitchRealColor">Real color:</label>
                                    <input id="glitchRealColor" type="color" />
                                </div>
                                <div class="form-group no-checkbox">
                                    <label for="glitchChangeSpeed">Change speed:</label>
                                    <input id="glitchChangeSpeed" max="500" min="10" type="number" value="50" />
                                </div>
                                <div class="form-group no-checkbox">
                                    <label for="glitchRealProbability">Real probability:</label>
                                    <input id="glitchRealProbability" max="100" min="0" type="number" value="5" />
                                </div>
                                <div class="form-group no-checkbox">
                                    <label for="glitchAutoStart">Auto start:</label>
                                    <input checked id="glitchAutoStart" type="checkbox" />
                                </div>
                                <div class="form-group no-checkbox">
                                    <label for="glitchCharsAllowed">Allowed characters:</label>
                                    <input
                                        id="glitchCharsAllowed"
                                        type="text"
                                        value="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <button class="section-header collapsible" onclick="toggleSection(this)">Characters</button>
                    <div class="section-content">
                        <button class="reset-default" onclick="resetCharactersToDefault()">Reset all characters</button>
                        <div id="charactersList"></div>
                        <div class="form-group add-character">
                            <label for="newCharacterName" style="display: none"></label>
                            <input id="newCharacterName" placeholder="Character name" type="text" />
                            <label for="newCharacterColor" style="display: none"></label>
                            <input id="newCharacterColor" type="color" />
                            <button class="success" onclick="addCharacter()">Add character</button>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <button class="section-header collapsible" onclick="toggleSection(this)">Scenes</button>
                    <div class="section-content">
                        <button class="reset-default" onclick="resetScenesToDefault()">Reset all scenes</button>
                        <div id="scenesList"></div>
                        <button class="success add-scene" onclick="addScene()">Create new scene</button>
                    </div>
                </div>
            </div>
        </div>
        <label for="fileInput" style="display: none"></label>
        <input accept=".json" id="fileInput" style="display: none" type="file" />
        <script src="js/filenameMapper.js"></script>
        <script src="js/memoryManager.js"></script>
        <script src="js/dialog.js"></script>
        <script src="js/gameImporter.js"></script>
        <script src="js/interface.js"></script>
        <script src="js/sequence.js"></script>
        <script src="js/editor.js"></script>
        <script src="js/galleryManager.js"></script>
        <script src="js/compositionEditor.js"></script>
        <script src="js/capture.js"></script>
        <script src="js/autoplay.js"></script>
        <script src="js/presets.js"></script>
    </body>
</html>
